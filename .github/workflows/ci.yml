name: CI

on:
  push:
    branches: [ main ]
  pull_request:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build_test:
    name: Build & Test (no default features)
    runs-on: ubuntu-latest
    env:
      # neutralize proxies, keep sparse
      http_proxy: ""
      https_proxy: ""
      no_proxy: ""
      CARGO_REGISTRIES_CRATES_IO_PROTOCOL: sparse
      CARGO_TERM_COLOR: always
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust (nightly; supports edition2024)
        uses: dtolnay/rust-toolchain@nightly
        with:
          components: clippy,rustfmt

      - name: Remove git proxies (belt-and-suspenders)
        run: |
          git config --global --unset-all http.proxy  || true
          git config --global --unset-all https.proxy || true

      - name: Cargo metadata (smoke)
        shell: bash
        run: |
          if [ -f Cargo.lock ]; then
            cargo metadata --format-version=1 --locked
          else
            cargo metadata --format-version=1
          fi

      - name: Check compiles (no features)
        shell: bash
        run: |
          if [ -f Cargo.lock ]; then
            cargo check --no-default-features --locked
          else
            cargo check --no-default-features
          fi

      - name: Feature compile matrix
        shell: bash
        run: |
          if [ -f Cargo.lock ]; then
            cargo check --no-default-features --locked
            cargo check --no-default-features --features cpu-exec --locked
            cargo check --no-default-features --features pkg --locked
          else
            cargo check --no-default-features
            cargo check --no-default-features --features cpu-exec
            cargo check --no-default-features --features pkg
          fi

      - name: Build
        shell: bash
        run: |
          if [ -f Cargo.lock ]; then
            cargo build --verbose --no-default-features --locked
          else
            cargo build --verbose --no-default-features
          fi

      - name: Test
        shell: bash
        run: |
          if [ -f Cargo.lock ]; then
            cargo test --verbose --no-default-features --locked
          else
            cargo test --verbose --no-default-features
          fi

      - name: Check formatting
        run: cargo fmt -- --check

      - name: Clippy
        shell: bash
        run: |
          if [ -f Cargo.lock ]; then
            cargo clippy --no-default-features --locked -- -D warnings
          else
            cargo clippy --no-default-features -- -D warnings
          fi
